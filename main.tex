%%%%%%%%%%%%%%%%%%%%%%%%% 
%% SITE A GARDER : http://titilog.free.fr/


\documentclass[10pt]{beamer}
% \includeonlyframes{yy}
\usepackage[english]{babel}
\usepackage{color, colortbl}
\definecolor{Gray}{gray}{0.9}
\newcolumntype{g}{>{\columncolor{Gray}}c}
\hypersetup{%
  % pdfborder = {0 0 0},
  colorlinks, urlcolor=blue, linkcolor=, }

\makeatletter \let\@mycite\@cite
\def\@cite#1#2{{\hypersetup{linkcolor=mLightBlue}[{#1\if@tempswa ,
      #2\fi}]}} \makeatother

\usetheme{m} %%%%%
% \usepackage[version=3]{mhchem}
\usepackage{caption}
\captionsetup[figure]{labelformat=empty}
\usepackage{fontspec}
\usepackage{xcolor}
\usepackage{siunitx}
% \usepackage[backend=bibtex]{biblatex} \usepackage[square]{natbib}
% \bibliography{main}
\usepackage[]{algorithm2e}
\usefonttheme[onlymath]{serif} \usepackage{amsmath}
\usepackage{subcaption} \usepackage{appendixnumberbeamer}
\usepackage{tabularx, booktabs} \usepackage{multirow}
\usepackage{multicol} \usepackage{array} \usepackage{pbox}
\usepackage{mathtools}
\usepackage{adjustbox}


\makeatletter
% save the meaning of \@footnotetext
\let\BEAMER@footnotetext\@footnotetext
\makeatother

\usepackage{setspace}

\makeatletter
% restore the meaning of \@footnotetext
\let\@footnotetext\BEAMER@footnotetext
% patch the relevant command to do single spacing in footnotes
\expandafter\patchcmd\csname beamerx@\string\beamer@framefootnotetext\endcsname
  {\reset@font}
  {\def\baselinestretch{\setspace@singlespace}\reset@font}
  {}{}
  \makeatother
  
\definecolor{darkred}{HTML}{D38989}
\definecolor{darkgreen}{HTML}{008866}
\PassOptionsToPackage{enumerate}{shortlabels}

\newcommand\ExtraSep
{\dimexpr\cmidrulewidth\relax}
\captionsetup{font=scriptsize,labelfont=scriptsize}
% \addtobeamertemplate{background canvas}{\transfade[duration=0.05]}{}


\title{Fusion of Three-Dimensional Mass Spectrometry and Magnetic Resonance Images}
\subtitle{\normalsize Application to the wheat grain}
\institute{OurCon 2021}
\author{{Florent \textsc{Grélard}\\
    David \textsc{Legland}, Mathieu \textsc{Fanuel}, Loïc \textsc{Foucat}, Hélène \textsc{Rogniaux}}}
\titlegraphic{\hspace*{0.01\textwidth}~%
  \includegraphics[width=0.2\textwidth]{fig/logo-inrae}\hspace*{0.075\textwidth}~%
  \includegraphics[width=0.2\textwidth]{fig/logo-bibs.png}\hspace*{0.075\textwidth}~%
  \includegraphics[width=0.2\textwidth]{fig/logo-biogenouest}\hspace*{0.075\textwidth}~%
  \includegraphics[width=0.2\textwidth]{fig/logo-region}\hspace*{0.01\textwidth}~%
} \setbeamercolor{bbb}{fg=red}

\let\oldfootnotesize\footnotesize
\renewcommand*{\footnotesize}{\oldfootnotesize\tiny}
\newcommand\labelitemi{$\bullet$}
\renewcommand{\thefootnote}{[\arabic{footnote}]}
\let\oldfootnote\footnote
\renewcommand\footnote[2][]{{\linespread{0.1}\oldfootnote[#1]{#2}}}

\newrobustcmd*{\footlessfullcite}{\AtNextCite{\renewbibmacro{in:}{}\renewbibmacro{year:}{}}\footfullcite}
% \newrobustcmd*{\lessfullcite}{\AtNextCite{\renewbibmacro{in:}{}\renewbibmacro{year:}{}}\fullcite}

\newcommand{\cfbox}[2]{%
    \colorlet{currentcolor}{.}%
    {\color{#1}%
    \fbox{\color{currentcolor}#2}}%
}


\newcommand{\backupbegin}{ \newcounter{framenumberappendix}
  \setcounter{framenumberappendix}{\value{framenumber}} }
\newcommand{\backupend}{
  \addtocounter{framenumberappendix}{-\value{framenumber}}
  \addtocounter{framenumber}{\value{framenumberappendix}} }
% http://mcclinews.free.fr/latex/introbeamer/les_couleurs.html
\begin{document}

% affiche le logo en bas à droite
% \logo{\includegraphics[height=0.5cm]{fig/logo-inra}}
% enlève la barre de navigation
\setbeamertemplate{navigation symbols}{ }
\setbeamertemplate{blocks}[rounded][shadow=false]
% Ombre aux blocks
\setbeamertemplate{caption}{\insertcaption}

\date{\vspace{0.2cm}13 October 2021} % set the Date
% \renewcommand{\insertnavigation}[1]{}

% \AtBeginSection[]{

% }

% \institute{INRAE de Nantes}
\makeatletter
\AtBeginPart{%
  \beamer@tocsectionnumber=0\relax
  \setcounter{section}{0}
}
\makeatother

\begin{frame}[plain]
  \titlepage
\end{frame}

\section{Context}
\begin{frame}{Wheat grain}
  Study of \textbf{wheat grain development}.

  \begin{figure}[ht]
    \centering
    \includegraphics[width=0.9\textwidth]{fig/stages}
    \caption{Evolution of the size and shape of the wheat grain over time.}
  \end{figure}

  
  \textbf{Cell walls}:
  \begin{itemize}
  \item specific mechanical properties for growth.
  \item regulate \textbf{water transfers}.
  \item layered polymers involving \textbf{celluloses}, \textbf{hemicelluloses}.
  \end{itemize}

  

\end{frame}

\begin{frame}{Arabinoxylans and water transfers}

  \alert{Arabinoxylans (AX)}: cell wall polysaccharides.
  \vspace{-0.2cm}
  \begin{figure}[ht]
    \centering
    \includegraphics[width=0.8\textwidth]{fig/AX}
  \end{figure}


  \vspace{-0.4cm}
  

  \begin{columns}[totalwidth=\textwidth]
    \begin{column}[t]{0.6\linewidth}
        {Varying spatial distribution of highly substituted AX \cite{Fanuel18}:}
    \end{column}
    \begin{column}[c]{0.4\linewidth}
      \hfill
      \begin{figure}[ht]
        \centering
        \begin{subfigure}[t]{0.45\textwidth}
          \centering
          \includegraphics[width=0.65\textwidth]{fig/3DAX}
          \label{subfig:3Darabinoxylan}
        \end{subfigure}%
        \begin{subfigure}[t]{0.45\textwidth}
          \centering
          \includegraphics[width=0.65\textwidth]{fig/water_transfer}
          \label{subfig:water_transfer}
        \end{subfigure}%
      \end{figure}
    \end{column}
  \end{columns}
  

  \underline{Aim:} to find spatial correlations between \textbf{molecules} and \textbf{water}.\\

  \vspace{0.5cm}
  \hrule width0.3\textwidth
  {
    \footnotesize
    Fanuel, M. et al. (2018).
    \textit{Distribution of cell wall hemicelluloses in the wheat grain endosperm: a 3D perspective}.
    Planta, 248(6):1505–1513.
  }
   \end{frame}


\begin{frame}{From images to molecule identification}
  \textbf{(a)} \textbf{MRI:} images enclosing the water distribution.
   \vspace{0.1cm}

  \textbf{(b)} \textbf{MSI (MALDI):} hyperspectral image: spectrum associated to each pixel location.

  $\rightarrow$ Automatic image \alert{fusion}.

  \underline{Problem:} differences between imaging modalities and resulting images.

  \vspace{-0.2cm}
  \begin{figure}[ht]
    \centering
    \begin{subfigure}[t]{0.4\textwidth}
      \centering \includegraphics[width=0.65\textwidth]{fig/mri_slice11}
      \caption{}
      \label{subfig:mri}
    \end{subfigure}%
    \begin{subfigure}[t]{0.4\textwidth}
      \centering \includegraphics[width=0.7\textwidth]{fig/maldi}
      \caption{}
      \label{subfig:maldi}
    \end{subfigure}%
    \label{fig:irm_vs_maldi}
  \end{figure}
  
\end{frame}

\begin{frame}{Workflow}
  On the \textbf{same grain}:

  \begin{figure}[ht]
    \centering
    \includegraphics[width=0.99\textwidth]{fig/ms_workflow}
  \end{figure}

\end{frame}

\begin{frame}{MR and MS imaging}

  \underline{\textbf{MRI:}} \hspace{0.5\textwidth} \underline{\textbf{MSI} (MALDI--TOF):}
  \begin{columns}
    \begin{column}[t]{.5\textwidth}
      \begin{itemize}
      \item \textbf{Formats}: RAW $\rightarrow$ NiFTI, tif.
      \item \textbf{3D+t images}:  \alert{multi-echo} sequence
      \item \textbf{Voxel size}: $50 \mu m \times 50 \mu m \times 500 \mu m$
      \end{itemize}
      \vspace{1cm}
      \begin{figure}[ht]
        \centering
        \begin{subfigure}[t]{0.33\textwidth}
          \centering \includegraphics[width=0.9\textwidth]{fig/echo2_1}
        \end{subfigure}%
        \begin{subfigure}[t]{0.33\textwidth}
          \centering \includegraphics[width=0.9\textwidth]{fig/echo2_2}
        \end{subfigure}%
        \begin{subfigure}[t]{0.33\textwidth}
          \centering \includegraphics[width=0.9\textwidth]{fig/echo2_3}
        \end{subfigure}%
        \caption{Different echoes}
      \end{figure}
    \end{column}
    \begin{column}[t]{.5\textwidth}
      \begin{itemize}
      \item \textbf{Formats}: fid $\rightarrow$ imzML.
      \item \textbf{Datacube}: spectral dimension (\textit{m/z} ratios)
      \item \textbf{Pixel size}: $25 \mu m \times 25 \mu m$, $80 \mu m$ inter-slice
      \end{itemize}
      \begin{figure}[ht]
        \centering
        \includegraphics[width=0.5\linewidth]{fig/maldi_cube}
      \end{figure}
    \end{column}
  \end{columns}
\end{frame}


% \begin{frame}{Workflow in 2D}

%   Joint analysis of \textbf{water} distribution (MRI) with \textbf{individual molecules} (MSI).

%   Previously described workflow \textbf{in 2D} \cite{Grelard_2021}.


%   \begin{figure}[ht]
%     \centering
%     \includegraphics<1>[width=0.5\textwidth]{fig/maldi_corr1}%
%     \includegraphics<2->[width=0.5\textwidth]{fig/maldi_corr2}%
%   \end{figure}

%   \visible<3->{

%     $\Rightarrow$ \textbf{mathematical} and \textbf{computational} methods: signal and image processing, statistical analysis.
  
%   }
% \end{frame}



\begin{frame}{3D issue}
  
  \underline{MS images:}%
      \begin{itemize}
      \item intensity inhomogeneities
      \item different orientations
      \end{itemize}

  

  \vspace{-0.3cm}
  \begin{figure}[ht]
    \centering
    \begin{subfigure}[b]{0.15\textwidth}
      \includegraphics[width=0.5\textwidth]{fig/cutwheatgrain}
       \textbf{MRI:}
     \end{subfigure}%
     \begin{subfigure}[c]{0.3\textwidth}
       \centering
       \includegraphics[width=0.65\textwidth]{fig/3D_density_aligned_manual0000}%
     \end{subfigure}%
     \begin{subfigure}[c]{0.3\textwidth}
       \centering
       \includegraphics[width=0.65\textwidth]{fig/3D_density_aligned_manual0003}%
     \end{subfigure}%
     \begin{subfigure}[c]{0.3\textwidth}
       \centering
       \includegraphics[width=0.65\textwidth]{fig/3D_density_aligned_manual0006}%
     \end{subfigure}
     \begin{subfigure}[b]{0.15\textwidth}
       \includegraphics[width=0.5\textwidth]{fig/cutwheatgrain}
       \textbf{MSI \\ (average):}%
     \end{subfigure}%
     \begin{subfigure}[c]{0.3\textwidth}
       \centering
       \includegraphics[width=0.65\textwidth]{fig/3D_segmentation0000}%
     \end{subfigure}%
     \begin{subfigure}[c]{0.3\textwidth}
       \centering
       \includegraphics[width=0.65\textwidth]{fig/3D_segmentation0003}%
     \end{subfigure}%
     \begin{subfigure}[c]{0.3\textwidth}
       \centering
       \includegraphics[width=0.65\textwidth]{fig/3D_segmentation0006}%
     \end{subfigure}
     
   \end{figure}

\visible<2-> {
  $\Rightarrow$ need for \textbf{reproducible} and
  \textbf{generic} computational methods.
}




    
\end{frame}


%\ begingroup \setbeamercolor{background
%     canvas}{bg=mLightBlue}
  
%   \setbeamertemplate{subsection in toc}
%   {\leavevmode\leftskip=2em$\bullet$\hskip1em\inserttocsubsection\par}
%   \setbeamercolor{section in toc}{fg=paleGrey, bg=mLightBlue}
%   \setbeamercolor{local structure}{fg=mLightBlueLighter,bg=mLightBlue}
%   \setbeamercolor{section in toc shaded}{fg=mLightBlue, bg=mLightBlue}
%   \setbeamertemplate{section in toc}[circle]
%   \setbeamertemplate{section in toc shaded}[default][80]
%   \setbeamertemplate{section in toc}{\hspace*{1em}\inserttocsection}

%   \setbeamercolor{subsection in toc}{fg=paleGrey, bg=mLightBlue}
%   \begin{frame}[noframenumbering,plain]
%     \frametitle{\textcolor{paleGrey}{Table des matières}}

%     \tableofcontents[currentsection, sectionstyle=show/hide,
%     hideothersubsections]
%   \end{frame}
%   \endgroup }



\AtBeginSection[]{
  \begingroup
  \setbeamercolor{background canvas}{bg=mLightBlue}

  \setbeamertemplate{subsection in toc}
  {\leavevmode\leftskip=2em$\bullet$\hskip1em\inserttocsubsection\par}

  % \setbeamercolor{section in toc shaded}{bg=paleGrey}


  \setbeamercolor{section in toc}{fg=paleGrey, bg=mLightBlue}
  \setbeamercolor{local structure}{fg=mLightBlueLighter,bg=mLightBlue}
  \setbeamercolor{section in toc shaded}{fg=mLightBlue, bg=mLightBlue}
  \setbeamertemplate{section in toc}[circle] \setbeamertemplate{section
    in toc shaded}[default][80]
    \setbeamertemplate{section in toc}{\hspace*{1em}\inserttocsection}



  \setbeamercolor{subsection in toc}{fg=paleGrey, bg=mLightBlue}
  \begin{frame}[plain,noframenumbering]
      \frametitle{\textcolor{paleGrey}{Contents}}
      \tableofcontents[currentsection, hideothersubsections]
    \end{frame}
    \endgroup
}
\section{3D workflow}
\begin{frame}{3D workflow}

  \vspace{-0.2cm}

  Extension of our \textbf{2D} workflow \cite{Grelard_2021}.
  \begin{enumerate}
  \item<2-> \textbf{3D registration}
  \item<3-> Spatial correlations with \textbf{uncertainties}
  \item<4-> \textbf{Visualization} of 3D MS images

  \end{enumerate}

  \begin{figure}[ht]
    \centering
    \includegraphics<1>[width=0.65\textwidth]{fig/workflow3D_0}%
    \includegraphics<2>[width=0.65\textwidth]{fig/workflow3D_2}%
    \includegraphics<3>[width=0.65\textwidth]{fig/workflow3D_3}%
    \includegraphics<4>[width=0.65\textwidth]{fig/workflow3D_4}%
  \end{figure}

  
  \hrule width0.3\textwidth
  \begin{spacing}{0.5}
     \footnotesize
    Grélard, F. et al. (2021).
    \textit{Esmraldi: efficient methods for the fusion of mass spectrometry and magnetic resonance
      images}. BMC Bioinformatics, 22(1).
  \end{spacing}

\end{frame}


% \AtBeginSection[]{ \begingroup \setbeamercolor{background
%     canvas}{bg=mLightBlue}
  
%   \setbeamertemplate{subsection in toc}
%   {\leavevmode\leftskip=2em$\bullet$\hskip1em\inserttocsubsection\par}
%   \setbeamercolor{section in toc}{fg=paleGrey, bg=mLightBlue}
%   \setbeamercolor{local structure}{fg=mLightBlueLighter,bg=mLightBlue}
%   \setbeamercolor{section in toc shaded}{fg=mLightBlue, bg=mLightBlue}
%   \setbeamertemplate{section in toc}[circle]
%   \setbeamertemplate{section in toc shaded}[default][80]
%   \setbeamertemplate{section in toc}{\hspace*{1em}\inserttocsection}

%   \setbeamercolor{subsection in toc}{fg=paleGrey, bg=mLightBlue}
%   \begin{frame}[noframenumbering,plain]
%     \frametitle{\textcolor{paleGrey}{Table des matières}}

%     \tableofcontents[currentsection, sectionstyle=show/hide,
%     hideothersubsections]
%   \end{frame}
%   \endgroup }


% \section{Normalization of MS images}
% \begin{frame}{Normalization}

%   Normalization factors:
%   \begin{enumerate}
%   \item Total ion count (TIC): sum of spectra intensities
%   \item Intensity of a standard molecule
%   \item Median
%   \end{enumerate}

%   \vspace{0.2cm}

%   Usually, the \textbf{TIC} is used: compensates for differences in the detected signals.
% \end{frame}


% \begin{frame}{TIC: problem}
%   Intensity variation between two spectra $\Rightarrow$
%   different TIC factors.
  
%   \begin{figure}[ht]
%     \centering
%     \includegraphics<1>[width=0.7\textwidth]{fig/normalization1}%
%     \includegraphics<2>[width=0.7\textwidth]{fig/normalization2}%
%     \includegraphics<3>[width=0.7\textwidth]{fig/normalization3}%
%   \end{figure}

% \end{frame}

% \begin{frame}{TIC: problem}

%   \underline{Example:} high intensity of the insulin peak in mouse pancreas \cite{Deininger_2011}.

%   \begin{figure}[ht]
%     \centering
%     \includegraphics[width=0.7\textwidth]{fig/normalization_defect}
%     \caption{}
%     \label{fig:normalization_defect}
%   \end{figure}

% \end{frame}


% \begin{frame}{Noise Ion Count}

%   \textbf{Idea:} remove peak contribution from the normalization factor.

%   \textbf{Calcul:} NIC = TIC - $\sum I_{\text{peaks}}$

%   \vspace{0.4cm}

%   \begin{figure}[ht]
%     \centering
%     \includegraphics<1>[width=0.7\textwidth]{fig/normalization2}%
%     \includegraphics<2>[width=0.7\textwidth]{fig/normalization_sic1}%
%     \includegraphics<3>[width=0.7\textwidth]{fig/normalization_sic2}%
%     \includegraphics<4>[width=0.7\textwidth]{fig/normalization_sic3}%
%     \caption{}
%     \label{fig:normalization_sic1}
%   \end{figure}


% \end{frame}


% \section{3D Registration}

\begin{frame}{Registration}

  Registration methods defined by three components:
  \begin{enumerate}
  \item The \textbf{geometrical transformation}: rigid, affine, deformable
  \item The \textbf{metric}: estimates the similarity between the reference and target images, using intensity or geometrical criteria
  \item The \textbf{optimization}: to find the minimum of the metric \vspace{0.3cm}
  \end{enumerate}
  \vspace{-0.4cm}
  

    \begin{figure}[ht]
    \centering
    \includegraphics<1>[width=0.9\textwidth]{fig/metric_1_2}%
    \includegraphics<2>[width=0.9\textwidth]{fig/metric_3_2}%
    \includegraphics<3>[width=0.9\textwidth]{fig/metric_7_2}%
    \includegraphics<4>[width=0.9\textwidth]{fig/metric_18_2}
    \label{fig:metric_1}
  \end{figure}

  

\end{frame}



% \begin{frame}{Registration}

%   \textbf{Problems:} intensity discrepancies, different orientations.

%    \begin{figure}[ht]
%     \centering
%     \begin{subfigure}[t]{0.5\textwidth}
%       \centering
%       \includegraphics[width=0.65\textwidth]{fig/mri_slice6.png}
%     \end{subfigure}%
%     \begin{subfigure}[t]{0.5\textwidth}
%       \centering
%       \includegraphics[width=0.65\textwidth]{fig/maldi_slice6}
%     \end{subfigure}%

%   \end{figure}

%   \onslide<2->{
%   $\Rightarrow$ Hard to choose  \textbf{appropriate parameters} in order to register all slices.
%   }
 

%   \end{frame}

\begin{frame}{Similarity metric}

  Geometrical metric: \textbf{distance transformation} (DT)

  \alert{Distance transformation}: maps each pixel of an object to its distance to the border.

  \begin{figure}[ht]
    \centering
    \begin{subfigure}[t]{0.5\textwidth}
      \centering
      \includegraphics<1>[width=0.65\textwidth]{fig/mri_slice6.png}%
      \includegraphics<2>[width=0.65\textwidth]{fig/mri_slice6_dt.png}
      \caption{}
      \label{subfig:mri_slice6_dt.png}
    \end{subfigure}%
    \begin{subfigure}[t]{0.5\textwidth}
      \centering
      \includegraphics<1>[width=0.65\textwidth]{fig/maldi_slice6.png}%
      \includegraphics<2>[width=0.65\textwidth]{fig/maldi_slice6_dt.png}
      \caption{}
      \label{subfig:maldi_slice6_dt.png}
    \end{subfigure}%
  \end{figure}

  
\end{frame}

\begin{frame}{Registration approach}
  
  Two steps:
  \begin{enumerate}
  \item \textbf{2D affine} registration
  \item \textbf{3D deformable} registration
  \end{enumerate}

  After \textbf{affine} registration:
  \begin{figure}[ht]
    \centering
    \includegraphics<1>[width=0.7\textwidth]{fig/affine}%
    \includegraphics<2>[width=0.7\textwidth]{fig/affine2}
  \end{figure}


  
\end{frame}



\begin{frame}{Deformable registration}
  
  \begin{columns}
    \begin{column}[t]{0.6\textwidth}
      \textbf{Variational methods}: displacements modelled by a \textbf{vector field}.

      Two forces: \vspace{0.2cm}

      \begin{enumerate}
      \item External forces: metric $\textcolor{darkgreen}{\mathcal{D}}$
      \item Internal forces: \textbf{regularization} term $\textcolor{purple}{\mathcal{S}}$
      \end{enumerate}

      \[
        \mathcal{J}[y] = \textcolor{darkgreen}{\mathcal{D}[\mathcal{T}[y], \mathcal{R}]} + \textcolor{purple}{\mathcal{S}[y]} \xrightarrow{y} \min
      \]
      
      % \[
      %   \mathcal{J}[y] = \textcolor{red}{\mathcal{D}[\mathcal{T}[y], \mathcal{R}]} + \textcolor{blue}{\mathcal{S}[y]} \xrightarrow{y} \min
      % \]
    \end{column}
    \begin{column}[t]{0.4\textwidth}
      \begin{figure}[ht]
        \centering
        \includegraphics<1>[width=0.95\textwidth]{fig/registration_nonrigid_vectorfield_2}%
        \includegraphics<2>[width=0.95\textwidth]{fig/registration_nonrigid_vectorfield_10}%
        \includegraphics<3>[width=0.95\textwidth]{fig/registration_nonrigid_vectorfield_30}%
        \includegraphics<4>[width=0.95\textwidth]{fig/registration_nonrigid_vectorfield}%
      \end{figure}
    \end{column}
  \end{columns}
\end{frame}

% \begin{frame}{Deformable registration: metric}

%   During registration, the shape is modified locally $\Rightarrow$
%   distance transformation values should be updated.

%   \vspace{0.4cm}
  
%   \textbf{New metric}: sum of squared differences with an \textbf{update} on DT values.

%   \begin{figure}[ht]
%   \centering
%   \begin{subfigure}[t]{0.2\textwidth}
%     \centering
%     \includegraphics[width=0.95\textwidth]{fig/registration_reference}
%     \caption{}
%     \label{subfig:registration_reference}
%   \end{subfigure}%
%   \begin{subfigure}[t]{0.2\textwidth}
%     \centering
%     \includegraphics[width=0.95\textwidth]{fig/registration_target}
%     \caption{}
%     \label{subfig:registration_target}
%   \end{subfigure}%
%   \begin{subfigure}[t]{0.2\textwidth}
%     \centering
%     \includegraphics[width=0.95\textwidth]{fig/registration_reference_dt}
%     \caption{}
%     \label{subfig:registration_dt_reference}
%   \end{subfigure}%
%   \begin{subfigure}[t]{0.2\textwidth}
%     \centering
%     \includegraphics[width=0.95\textwidth]{fig/registration_target_dt_interpol.png}
%     \caption{}
%     \label{subfig:registration_dt_target_interpol}
%   \end{subfigure}%
%   \begin{subfigure}[t]{0.2\textwidth}
%     \centering
%     \includegraphics[width=0.95\textwidth]{fig/registration_target_dt}
%     \caption{}
%     \label{subfig:registration_dt_target}
%   \end{subfigure}%
% \end{figure}
% \end{frame}




\begin{frame}{Statistical analysis}

  Done iteratively on each pair of corresponding 2D slices.
  
  \begin{columns}
    \begin{column}[t]{0.6\textwidth}
      \begin{enumerate}
      \item Dimension reduction of the MS image by \textbf{NMF} 
      \item \textbf{Projection} of the MR image onto the NMF axes
      \item Selection of ion images which are \textbf{the closest} to the MR projection
      \end{enumerate}
    \end{column}
    \begin{column}[t]{0.4\textwidth}
      \begin{figure}[ht]
        \centering
        \includegraphics[width=0.95\textwidth]{fig/pca_big3_en}
      \end{figure}
    \end{column}
  \end{columns}
\end{frame}

\begin{frame}{Statistical analysis}
  % Identification of molecules in MALDI which \textbf{correlate with MR images}:

  \textbf{Problem:} similar regions in both images might not be aligned.

  \begin{figure}[ht]
  \centering
  % \begin{subfigure}[t]{0.33\textwidth}
  %   \centering
  %   \includegraphics[width=0.9\textwidth]{fig/t2_6_original}
  %   \caption{}
  %   \label{subfig:t2_6_original}
  % \end{subfigure}%
  % \begin{subfigure}[t]{0.33\textwidth}
  %   \centering
  %   \includegraphics[width=0.9\textwidth]{fig/msi_6_original}
  %   \caption{}
  %   \label{subfig:msi_6_original}
  % \end{subfigure}%
  \begin{subfigure}[t]{0.33\textwidth}
    \centering
    \includegraphics[width=0.9\textwidth]{fig/overlay_t2_6_original}
  \end{subfigure}%
\end{figure}

\end{frame}


\begin{frame}{Statistical analysis}
  \textbf{Proposed method:} exhaustive registration of individual NMF component images.


  \begin{figure}[ht]
    \centering
    \includegraphics<1>[width=0.9\textwidth]{fig/translation_nmf_0}%
    \includegraphics<2>[width=0.9\textwidth]{fig/translation_nmf_1}%
    \includegraphics<3>[width=0.9\textwidth]{fig/translation_nmf_2}%
    \includegraphics<4>[width=0.9\textwidth]{fig/translation_nmf_3}%
  \end{figure}

  
\end{frame}







% \section{Visualization}

% \begin{frame}{Visualisation 3D}
  
%   3D volumetric rendering:
%   \begin{figure}[ht]
%     \centering
%     \includegraphics[width=0.5\textwidth]{fig/visu_3d.png}
%     \caption{}
%     \label{fig:visu_3d.png}
%   \end{figure}

% \end{frame}

\section{Results}

\begin{frame}{Registration}

  \vspace{-0.3cm}
  Percentage of shared pixels between the \textbf{(a)} MR and \textbf{(b-c)} MS images:
  \begin{itemize}
  \item \textbf{affine} with an intensity-based metric: \textbf{77.9\%}
  \item \textbf{(b)} \textbf{affine} registration with DT: \textbf{84.6\%}
  % \item \textbf{(c)} \textbf{variational} without DT update: \textbf{90.2\%}
  \item \textbf{(c)} \textbf{deformable} registration with DT: \textbf{93.2\%}
  \end{itemize}

  \begin{figure}[ht]
  \centering
  \begin{subfigure}[t]{0.25\textwidth}
    \centering
    \includegraphics[width=0.95\textwidth]{fig/registration_wheat_mri}
    \caption{}
    \label{subfig:registration_wheat_mri}
  \end{subfigure}%
  \begin{subfigure}[t]{0.25\textwidth}
    \centering
    \includegraphics[width=0.95\textwidth]{fig/registration_wheat_affine}
    \caption{}
    \label{subfig:registration_wheat_affine}
  \end{subfigure}%
  % \begin{subfigure}[t]{0.25\textwidth}
  %   \centering
  %   \includegraphics[width=0.95\textwidth]{fig/registration_wheat_ssd}
  %   \caption{}
  %   \label{subfig:registration_wheat_ssd}
  % \end{subfigure}%
  \begin{subfigure}[t]{0.25\textwidth}
    \centering
    \includegraphics[width=0.95\textwidth]{fig/registration_wheat_dtssd}
    \caption{}
    \label{subfig:registration_wheat_dtssd}
  \end{subfigure}%
\end{figure}
\end{frame}

% \begin{frame}{Statistical analysis}
%   Mean squared error of the standard deviation between the \textbf{(a)} original and the \textbf{(b-c)} projected MR images:
%   \begin{itemize}
%   \item \textbf{without} NMF component image registration: \textbf{12.4}
%   \item \textbf{with} NMF component image registration: \textbf{11.5}
%   \end{itemize}

%     \begin{figure}[ht]
%   \centering
%   \begin{subfigure}[t]{0.3\textwidth}
%     \centering
%     \includegraphics[width=0.95\textwidth]{fig/t2_6_original}
%     \caption{}
%     \label{subfig:t2_6_original}
%   \end{subfigure}%
%   \begin{subfigure}[t]{0.3\textwidth}
%     \centering
%     \includegraphics[width=0.95\textwidth]{fig/reconstruction_t2_translated.png}
%     \caption{}
%     \label{subfig:reconstruction_t2_translated.png}
%   \end{subfigure}%
%     \begin{subfigure}[t]{0.3\textwidth}
%     \centering
%     \includegraphics[width=0.95\textwidth]{fig/msi_6_original.png}
%     \caption{}
%     \label{subfig:reconstruction_t2_translated.png}
%   \end{subfigure}%
% \end{figure}

% \end{frame}

\begin{frame}{Correlative analysis}

  Spatial correlations (sample 2D images):

    \begin{figure}[ht]
    \centering
    \begin{subfigure}[t]{0.33\textwidth}
      \centering
      \includegraphics[width=0.9\textwidth]{fig/mri_slice8_250_2}
      \caption{MR image}
      \label{subfig:mri_slice8_250}
    \end{subfigure}%
    \begin{subfigure}[t]{0.33\textwidth}
      \centering
      \includegraphics[width=0.9\textwidth]{fig/t2_sic_n10_rapports_8_13.png}
      \caption{Highly subst. AX}
      \label{subfig:3D_250DJ}
    \end{subfigure}%
    \begin{subfigure}[t]{0.33\textwidth}
      \centering
      \includegraphics[width=0.9\textwidth]{fig/t2_sic_n10_7_6.png}
      \caption{Acetylated AX}
      \label{subfig:zonetir_0}
    \end{subfigure}%


  \end{figure}
  \vspace{-0.2cm}

  Distribution similar to that of water:
  \begin{itemize}
  \item AX with high number of \textbf{arabinosyl substitutions} ($\frac{\text{AX6}}{\text{AX5}}$ ratio)
  \item AX with a high number of \textbf{acetyl groups}.
  \end{itemize}


\end{frame}



\section{Conclusion}

\begin{frame}{Conclusion}

  \begin{columns}
    \begin{column}{.8\textwidth}

      Workflow suited for 3D MS images.

      \vspace{0.2cm}
      \begin{spacing}{1.5}

        \textbf{Esmraldi}: tools for the fusion of MS images.
        \begin{itemize}
        \item Open Source
        \item Python 3, supports \texttt{imzML}
        \item \url{https://github.com/fgrelard/Esmraldi}
        \end{itemize}

      \end{spacing}
    \end{column}

    \begin{column}{.2\textwidth}
      \begin{figure}[ht]
        \centering
        \includegraphics[width=0.9\textwidth]{fig/3D_250DJ}
      \end{figure}

    \end{column}
  \end{columns}

 


  \vspace{0.2cm}

  Prospects:
  \begin{itemize}
  \item \textbf{Full 3D} statistical analysis.
  \item On-going projects at \textbf{CBMN}, Bordeaux.
  \end{itemize}



\end{frame}

\section{}
\begin{frame}[plain, noframenumbering]{Acknowledgments}
  \begin{figure}[ht]
      \centering
      \includegraphics[width=0.7\textwidth]{fig/photoequipe}
    \end{figure}
    
    {\scriptsize
  \begin{itemize}
  \item \textbf{BIBS platform} : David Legland, Mathieu Fanuel, Loïc Foucat, Hélène Rogniaux
  \item \textbf{Former members}: Bastien Arnaud
  \item \textbf{Cell Walls team}: Luc Saulnier, Fabienne Guillon, Camille Alvarado, Anne--Laure Chateigner--Boutin
  \end{itemize}
}
\vspace{-0.7cm}
  \hspace*{0.01\textwidth}~%
  \includegraphics[width=0.2\textwidth]{fig/logo-inrae}\hspace*{0.075\textwidth}~%
  \includegraphics[width=0.2\textwidth]{fig/logo-bibs.png}\hspace*{0.075\textwidth}~%
  \includegraphics[width=0.2\textwidth]{fig/logo-biogenouest}\hspace*{0.075\textwidth}~%
  \includegraphics[width=0.2\textwidth]{fig/logo-region}\hspace*{0.01\textwidth}~%

\end{frame}




% \begin{frame}{Local scale variations}

%   \visible<2->{
%     The distance transform values are dependent on the local scale of the object.
%     }

%   \visible<3->{
%     \textbf{Idea:} normalize the DT values by the \textbf{local scale} of the object, taken as e.g. the object's radius.
%   }
  

%   \begin{figure}[ht]
%     \flushleft
%     \begin{subfigure}[t]{0.2\textwidth}
%       \centering
%       \includegraphics[width=0.95\textwidth]{fig/prospect_reference}
%       \caption{}
%       \label{subfig:prospect_reference}
%     \end{subfigure}%
%     \begin{subfigure}[t]{0.2\textwidth}
%       \centering
%       \includegraphics[width=0.95\textwidth]{fig/prospect_target}
%       \caption{}
%       \label{subfig:prospect_target}
%     \end{subfigure}%
%     \only<2->{%
%     \begin{subfigure}[t]{0.2\textwidth}
%       \centering
%       \includegraphics[width=0.95\textwidth]{fig/prospect_registered_target}
%       \caption{}
%       \label{subfig:prospect_registered_target}
%     \end{subfigure}%
%     }%
%     \only<3->{%
%       \begin{subfigure}[t]{0.2\textwidth}
%         \centering
%         \includegraphics[width=0.95\textwidth]{fig/prospect_normalized_dt}
%         \caption{}
%         \label{subfig:prospect_normalized_dt}
%       \end{subfigure}%
%     }%
%     \only<4->{%
%       \begin{subfigure}[t]{0.2\textwidth}
%         \centering
%         \includegraphics[width=0.95\textwidth]{fig/prospect_registered_target_normalized}
%         \caption{}
%         \label{subfig:prospect_registered_target_normalized}
%       \end{subfigure}%
%     }
%   \end{figure}

% \end{frame}






\appendix
\setbeamertemplate{headline}{%
  % \nointerlineskip
  % \begin{beamercolorbox}[wd=\paperwidth,leftskip=0.5cm,ht=0pt,dp=0pt]{block title}%
  %   \usebeamerfont{page number in head/foot}{\insertsection}
  % \end{beamercolorbox}%
  % \if@useTitleProgressBar
  % \nointerlineskip
  % % \vspace{-0.7cm}
  % \begin{beamercolorbox}[wd=\paperwidth,ht=0pt,dp=5pt]{section}
  %   \progressbar@titleprogressbar
  % \end{beamercolorbox}
  % \fi
  % \nointerlineskip
}

% \setbeamertemplate{frametitle}{%
%   \begin{beamercolorbox}[wd=\paperwidth,leftskip=0.7cm,rightskip=0.3cm,ht=0pt,dp=0pt]{frametitle}
%     \usebeamerfont{frametitle}\MakeLowercase{\protect\insertframetitle}
%   \end{beamercolorbox}
% }

\begin{frame}[allowframebreaks]
  \frametitle{Références}
  \setbeamertemplate{bibliography item}{$\bullet$}
  \bibliographystyle{apalike}
  \scriptsize{
    \bibliography{main}
  }
\end{frame}



\end{document}
